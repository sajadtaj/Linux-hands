### **🛠 رویه جامع برای بررسی و تحلیل فرآیندهای مشکوک در سیستم لینوکس**  
**📌 هدف:** یافتن فرآیندهای مشکوک، بررسی رفتار آن‌ها، شناسایی منابع مصرفی، وابستگی‌ها، لاگ‌ها، و نحوه اجرای مجدد آن‌ها. همچنین ارائه راه‌حل‌هایی به منظور مواجهه یا رفع آنها .  

---

## **🔎 ۱. یافتن فرآیندهای مشکوک**
### **۱.۱ مشاهده فرآیندهای در حال اجرا**
برای مشاهده تمام فرآیندهای فعال:
```bash
# برای شناسایی فرایندهای پرمصرف CPU.
ps aux --sort=-%cpu

# رای شناسایی فرایندهای پرمصرف RAM.
ps aux --sort=-%mem
```
یا:
```bash
top
```
یا:
```bash
htop  # (اگر نصب نیست، نصب کنید: sudo apt install htop -y)
```
❗ **موارد مشکوک:**  
- مصرف CPU یا RAM بیش‌ازحد  
- فرآیندهایی که به‌عنوان `nobody`، `www-data` یا کاربران غیرمعمول اجرا شده‌اند  
- اسامی فرآیندهایی که شبیه فرآیندهای سیستمی هستند اما کاملاً مشابه نیستند (مثلاً `kauditd0` در برابر `kauditd`)  

---

## **📂 ۲. بررسی اطلاعات اضافی فرآیند**
### **۲.۱ یافتن جزئیات بیشتر درباره فرآیند**
```bash
ps -fp <PID>
```
```bash
cat /proc/<PID>/status
```
```bash
ls -l /proc/<PID>/exe
```

❗ **بررسی مسیر فایل اجرایی:**  
- اگر مسیر `/tmp`, `/var/tmp`, `/dev/shm`, یا `/usr/local/bin` باشد، ممکن است مشکوک باشد.  

### **۲.۲    دیدن همه والد ها بصورت درختی**

با دستور زیر میتوانیم همه والدهای یک پروسه را ببینینم. مفید است چرا که به ما نشان میدهد ایا این پروسه والد معتبری دارد یا نه.
```
pstree -s <pid>
```



### **۲.۳ مشاهده متغیرهای محیطی فرآیند**
```bash
cat /proc/<PID>/environ | tr '\0' '\n'
```
🔍 **در جستجوی:**  
- مسیرهای مشکوک  
- API keys یا اطلاعات حساس  

---

## **📡 ۳. بررسی اتصالات شبکه‌ای فرآیند**
### **۳.۱ مشاهده پورت‌های باز**
```bash
sudo netstat -tulnp | grep <PID>
```
یا:
```bash
sudo lsof -i -n -P | grep <PID>
```
❗ **موارد مشکوک:**  
- اتصال به **آی‌پی خارجی نامشخص**  
- استفاده از **پورت‌های غیرعادی**  

### **۳.۲ بررسی ارتباطات شبکه‌ای اخیر**
```bash
sudo ss -tup | grep <PID>
```

---

## **📜 ۴. بررسی فایل‌های مرتبط با فرآیند**
### **۴.۱ مشاهده فایل‌های باز شده توسط فرآیند**
```bash
sudo lsof -p <PID>
```
❗ **موارد مشکوک:**  
- اگر فرآیند در حال خواندن یا نوشتن در `/tmp`, `/var/tmp`, `/dev/shm`, یا `/etc/cron*` است، احتمال بدافزار بودن آن زیاد است.  

---

## **🕵 ۵. بررسی لاگ‌های سیستم**
### **۵.۱ بررسی لاگ‌های کرنل**
```bash
sudo dmesg | grep "<PID>"
```

### **۵.۲ بررسی لاگ‌های کلی سیستم**
```bash
sudo journalctl -u <SERVICE_NAME> --no-pager --lines=100
```
یا:
```bash
sudo tail -n 100 /var/log/syslog
```

### **۵.۳ بررسی لاگ‌های سرویس‌های خاص**
```bash
sudo tail -n 100 /var/log/auth.log
sudo tail -n 100 /var/log/messages
```

### **۵.4 بررسی لاگ‌های برخی سرویس مربوط**
```bash
cat var/log/<service-name
```
---





## **🔄 ۶. شناسایی و جلوگیری از اجرای مجدد**
### **۶.۱ بررسی `crontab` و `systemd`**
```bash
crontab -l
sudo crontab -l
ls -la /etc/cron*
```
```bash
systemctl list-units --type=service --state=running | grep <PROCESS_NAME>
```
🔍 **اگر سرویسی مشکوک پیدا شد، غیرفعال و حذف کنید:**
```bash
sudo systemctl disable --now <SERVICE_NAME>
sudo rm -rf /etc/systemd/system/<SERVICE_NAME>.service
```

### **۶.۲ بررسی اسکریپت‌های راه‌انداز**
```bash
ls -la /etc/init.d/
ls -la /etc/rc.local
```
🔍 **اگر اسکریپت مشکوکی پیدا شد، آن را بررسی و حذف کنید.**

---

## **🛑 ۷. حذف فرآیند و جلوگیری از بازگشت آن**
### **۷.۱ حذف فرآیند از حافظه**
```bash
sudo kill -9 <PID>
```
اگر به‌طور خودکار بازگشت، احتمال دارد که یک فرآیند مادر داشته باشد. برای بررسی:
```bash
ps -o ppid= -p <PID>
```
و سپس **فرآیند مادر** را نیز متوقف کنید.

### **۷.۲ حذف فایل اجرایی**
```bash
sudo rm -rf /path/to/executable
```
🔴 **اگر حذف نشد، سیستم در حالت `immutable` قرار دارد. ابتدا immutable را بردارید:**
```bash
sudo chattr -i /path/to/executable
```

---

## **🛡 ۸. بررسی سیستم برای بدافزار**
### **۸.۱ استفاده از `rkhunter` و `chkrootkit`**
```bash
sudo apt install rkhunter chkrootkit -y
sudo rkhunter --check
sudo chkrootkit
```

### **۸.۲ بررسی فایل‌های ناشناس در `/tmp` و `/dev/shm`**
```bash
ls -lah /tmp
ls -lah /dev/shm
```

### **۸.۳ بررسی کاربرانی که اخیراً وارد سیستم شده‌اند**
```bash
last -a
```
❗ اگر کاربری ناشناس مشاهده کردید، احتمال هک شدن سرور وجود دارد.

---
## ۹. وقتی نام پروسه یا بخشی از آن را میدانیم

#### مثلا میدانیم پروسه مربوط به `airflow` هست:

### ۱. با استفاده از `ps` و `grep`:
```bash
ps aux | grep -i '[a]ir'
```
- این دستور تمام فرآیندهایی که شامل رشته **"air"** در نام هستند را نشان می‌دهد، حتی اگر بخشی از نام باشند (مثل `walair` یا `airflow`).
- `[a]ir` برای جلوگیری از نمایش خود دستور `grep` در نتایج استفاده می‌شود.
- `-i`: برای جستجوی غیرحساس به حروف بزرگ/کوچک (اختیاری).

**مثال خروجی:**
```
user1     1234  0.0  0.5  12345  6789 ?        Ssl  10:00   0:00 /usr/bin/airflow
user2     5678  0.1  1.2  98765 12345 ?        Sl   10:05   0:02 /opt/walair --config /etc/walair.conf
```

---

### ۲. با استفاده از `pgrep`:
```bash
pgrep -l air
```
- این دستور مستقیماً PID و نام فرآیندهایی که شامل **"air"** هستند را نمایش می‌دهد.

**مثال خروجی:**
```
1234 airflow
5678 walair
```

---

### ۳. جستجوی پیشرفته با `grep`:
اگر می‌خواهید فقط فرآیندهایی را پیدا کنید که **"air"** در **ابتدای نام** آنها قرار دارد، از `^` در `grep` استفاده کنید:
```bash
ps aux | grep -i '^[^ ]*air'
```
- `^`: نشانگر شروع خط.
- `[^ ]*`: تمام کاراکترهای غیرفضایی قبل از "air".

---

### چرا این روش‌ها تمام حالات را پوشش می‌دهند؟
- **`grep 'air'`** به طور پیش‌فرض به دنبال رشته **"air"** در هر نقطه از متن است (مثل `walair`، `airflow`، `something-air`).
- اگر از `grep '^air'` استفاده کنید، فقط فرآیندهایی که با **"air"** شروع می‌شوند (مثل `airflow`) را نشان می‌دهد.

---

### مثال عملی:
فرض کنید فرآیندهای زیر در حال اجرا هستند:
```bash
1234 airflow
5678 walair
9012 some_air_process
3456 airplane
```
- **`ps aux | grep 'air'`** تمام ۴ فرآیند را نمایش می‌دهد.
- **`ps aux | grep '^air'`** فقط فرآیند `airflow` را نشان می‌دهد.




##  راه‌حل‌های پیشنهادی  دیگر 
✅ کاهش سطح دسترسی فرآیندها با `AppArmor` یا `SELinux`  
✅ بستن پورت‌های غیرضروری با `iptables` یا `ufw`  
✅ بررسی سیستم‌فایل برای تغییرات ناگهانی با `tripwire`  
✅ استفاده از `fail2ban` برای جلوگیری از ورود غیرمجاز  
✅ تغییر رمز عبور کاربران مشکوک  

