# هدف
این مستند آموزشی شما را با روش ایجاد Backup از سیستم‌عامل لینوکس با استفاده از دستور `rsync` آشنا می‌کند. rsync یک ابزار قدرتمند برای همگام‌سازی و ایجاد نسخه‌های پشتیبان است که مزایایی مانند:
- انتقال افزایشی (فقط فایل‌های تغییر کرده)
- حفظ مجوزها و ویژگی‌های فایل
- امکان فشرده‌سازی داده‌ها
- امکان کار از راه دور (از طریق SSH)

## اقدامات اولیه
1. **نصب rsync** (در صورت عدم وجود):
   ```bash
   # برای سیستم‌های مبتنی بر Debian/Ubuntu
   sudo apt install rsync

   # برای سیستم‌های مبتنی بر RHEL/CentOS
   sudo yum install rsync
   ```

2. **تعیین فضای ذخیره‌سازی Backup**:
   - یک درایو اکسترنال
   - یک پارتیشن جداگانه
   - فضای ذخیره‌سازی شبکه یا سرور راه‌دور

3. **ایجاد ساختار دایرکتوری برای Backup**:
   ```bash
   mkdir -p /backup/system
   ```
# مسیر و محل ذخیره سازی
برای یافتن **فضاهای ذخیره‌سازی مناسب** جهت انتقال بک‌آپ در لپ‌تاپ شخصی‌تان، باید دیسک‌ها و پارتیشن‌های **قابل دسترس** و **دارای فضای خالی کافی** را شناسایی کنید.  

---

## **۱. لیست تمام دیسک‌ها و پارتیشن‌های موجود**
ابتدا دیسک‌های متصل به سیستم را بررسی کنید:

### **دستور `lsblk` (نمایش درختی دیسک‌ها و پارتیشن‌ها)**
```bash
lsblk -o NAME,FSTYPE,SIZE,MOUNTPOINT,LABEL
```
**مثال خروجی:**
```
NAME        FSTYPE   SIZE MOUNTPOINT  LABEL
nvme0n1            476.9G            
├─nvme0n1p1 vfat     512M /boot/efi   EFI
├─nvme0n1p2 ext4    475.5G /          root
└─nvme0n1p3 swap     976M [SWAP]      
sda               931.5G            
└─sda1      ext4    931.5G /mnt/backup mybackup
```
**نکات مهم:**
- **دیسک‌های بدون `MOUNTPOINT`** هنوز مونت نشده‌اند و باید ابتدا مونت شوند.
- **دیسک‌های با `MOUNTPOINT`** (مثل `/`, `/boot/efi`, `/mnt/backup`) در حال استفاده هستند.
- **`FSTYPE`** نشان‌دهنده نوع فایل‌سیستم (`ext4`, `ntfs`, `vfat` و ...).

---

## **۲. بررسی فضای خالی دیسک‌های مونت‌شده**
برای دیدن **فضای خالی** دیسک‌های مونت‌شده:

### **دستور `df` (نمایش فضای دیسک)**
```bash
df -h
```
**مثال خروجی:**
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme0n1p2  467G  200G  244G  46% /
/dev/sda1       916G  100G  770G  12% /mnt/backup
```
**تحلیل:**
- **`/`** (پارتیشن اصلی سیستم): **244GB** فضای خالی دارد.
- **`/mnt/backup`** (دیسک اکسترنال یا دوم): **770GB** فضای خالی دارد → **مناسب برای بک‌آپ**.

---

## **۳. یافتن دیسک‌های اکسترنال (USB/HDD)**
اگر از **دیسک اکسترنال** (مثل فلش یا HDD) استفاده می‌کنید، معمولاً در `/media/username/` یا `/mnt/` مونت می‌شوند.

### **روش ۱: بررسی `/media` و `/mnt`**
```bash
ls /media/$USER/
ls /mnt/
```

### **روش ۲: استفاده از `udisksctl` (برای دیسک‌های USB)**
```bash
udisksctl status
```

---

## **۴. مونت کردن دیسک‌های جدید (اگر مونت نشده‌اند)**
اگر دیسکی دارید که **مونت نشده** (مثلاً `/dev/sdb1`)، ابتدا باید آن را مونت کنید:

### **۱. ایجاد پوشه مونت (مثلاً `/mnt/backup`)**
```bash
sudo mkdir -p /mnt/backup
```

### **۲. مونت کردن پارتیشن**
```bash
sudo mount /dev/sdb1 /mnt/backup
```

### **۳. بررسی موفقیت‌آمیز بودن مونت**
```bash
df -h | grep /mnt/backup
```

### **۴. بررسی فضای خالی**

```bash
df -h /mnt/backup
```

---

## **۵. بهترین گزینه‌ها برای بک‌آپ**
| محل بک‌آپ | مزایا | معایب |
|-----------|-------|-------|
| **پارتیشن دوم روی HDD/SSD داخلی** (`/mnt/backup`) | سرعت بالا، همیشه متصل | اگر سیستم آسیب ببیند، بک‌آپ هم از بین می‌رود |
| **دیسک اکسترنال (USB/HDD)** (`/media/user/external`) | امن‌تر، قابل حمل | نیاز به اتصال دستی |
| **سرور راه‌دور (NFS/Samba/SSH)** | امنیت بالا، دسترسی از راه دور | نیاز به اینترنت/شبکه |
| **سرویس‌های ابری (Nextcloud, Dropbox)** | دسترسی از هرجا | نیاز به فضای خریداری شده |


---

### **جمع‌بندی:**
✅ **فضاهای مناسب برای بک‌آپ:**  
1. **دیسک دوم داخلی** (اگر وجود دارد)  
2. **دیسک اکسترنال (USB/HDD)**  
3. **فضای شبکه (NAS/سرور)**  

✅ **چک‌لیست قبل از بک‌آپ:**  
✔ فضای خالی کافی (`df -h`)  
✔ دیسک مونت‌شده (`mount | grep /mnt/backup`)  
✔ دسترسی نوشتن (`touch /mnt/backup/testfile && rm /mnt/backup/testfile`)  


# دستورات اصلی rsync

### ساختار کلی دستور:
```bash
rsync [options] source destination
```

### مثال‌های کاربردی:
1. **Backup اولیه**:
   ```bash
   rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / /backup/system
   ```

2. **Backup افزایشی** (فقط فایل‌های تغییر کرده):
   ```bash
   rsync -aAXv --delete --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / /backup/system
   ```

3. **Backup از راه دور** (از طریق SSH):
   ```bash
   rsync -aAXvz -e ssh --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / user@remote_host:/backup/system
   ```

## پارامترهای مهم rsync

| پارامتر | توضیح |
|---------|-------|
| `-a`    | حالت آرشیو (حفظ مجوزها، مالکیت، timestampها) |
| `-A`    | حفظ ACLها |
| `-X`    | حفظ extended attributes |
| `-v`    | نمایش جزئیات عملیات (verbose) |
| `-z`    | فشرده‌سازی داده‌ها هنگام انتقال |
| `-P`    | نمایش پیشرفت و ادامه انتقال ناتمام |
| `--delete` | حذف فایل‌هایی در مقصد که در مبدا وجود ندارند |
| `--exclude` | حذف فایل‌ها/دایرکتوری‌های مشخص |
| `--exclude-from` | خواندن لیست exclude از فایل |
| `-e ssh` | استفاده از SSH برای انتقال امن |
| `--link-dest` | استفاده از hardlink برای فایل‌های تغییر نکرده |

## مبدا و مقصد

### مبدا (Source):
- `/` - کل سیستم (با exclude کردن دایرکتوری‌های غیرضروری)
- `/home` - فقط دایرکتوری home کاربران
- `/etc` - فقط فایل‌های پیکربندی سیستم

### مقصد (Destination):
- `/backup/system` - دایرکتوری محلی
- `/mnt/backup_drive` - درایو اکسترنال
- `user@remote_host:/backup` - سرور راه‌دور
- `/media/backup` - پارتیشن جداگانه

## فایل‌های مهم برای Backup

1. **فایل‌های پیکربندی**:
   - `/etc/` (تمام فایل‌های پیکربندی سیستم)
   - `/home/*/.config/` (تنظیمات کاربری)

2. **داده‌های کاربر**:
   - `/home/` (تمام دایرکتوری‌های کاربران)
   - `/var/www/` (در صورت وجود وب سرور)

3. **پایگاه‌های داده**:
   - `/var/lib/mysql/` (برای MySQL)
   - `/var/lib/postgresql/` (برای PostgreSQL)

4. **لاگ‌های سیستم** (اختیاری):
   - `/var/log/`

## فایل‌هایی که نیاز به Backup ندارند

1. **دایرکتوری‌های سیستمی موقت**:
   - `/dev/`
   - `/proc/`
   - `/sys/`
   - `/tmp/`
   - `/run/`
   - `/mnt/`
   - `/media/`
   - `/lost+found/`

2. **فایل‌های حجیم غیرضروری**:
   - فایل‌های cache (`/var/cache/`)
   - فایل‌های دانلود شده
   - فایل‌های موقت مرورگرها

3. **سیستم‌فایل‌های مجازی**:
   - `/swapfile`
   - فایل‌های صفحه‌بندی (swap)

## نکات مهم برای Backup با rsync

1. **همیشه قبل از اجرای دستور با `--dry-run` تست کنید**:
   ```bash
   rsync -aAXv --dry-run --exclude=... / /backup/system
   ```

2. **از `--delete` با احتیاط استفاده کنید** زیرا فایل‌های اضافی در مقصد را حذف می‌کند.

3. **برای Backupهای دوره‌ای از cron استفاده کنید**:
   ```bash
   # ویرایش crontab
   crontab -e

   # اضافه کردن خط زیر برای Backup روزانه در ساعت 2 شب
   0 2 * * * /usr/bin/rsync -aAX --delete --exclude={...} / /backup/system
   ```

4. **حفظ چندین نسخه Backup**:
   - از اسکریپت‌هایی با `--link-dest` استفاده کنید تا نسخه‌های مختلف Backup با حداقل فضای اضافی حفظ شوند.

5. **بررسی یکپارچگی Backup**:
   - پس از اتمام Backup، سیستم فایل را بررسی کنید:
   ```bash
   touch /backup/system/backup_completed
   ```

6. **رمزنگاری Backupهای حساس**:
   - برای Backupهای خارجی، از LUKS یا ابزارهای رمزنگاری استفاده کنید.

7. **مستندسازی**:
   - لیست دقیق فایل‌های exclude شده را در یک فایل متنی ذخیره کنید.
   - تاریخ و جزئیات هر Backup را ثبت کنید.

## اسکریپت نمونه برای Backup کامل سیستم

```bash
#!/bin/bash

# تنظیمات
BACKUP_DIR="/backup/system"
EXCLUDE_LIST=(
  "/dev/*"
  "/proc/*"
  "/sys/*"
  "/tmp/*"
  "/run/*"
  "/mnt/*"
  "/media/*"
  "/lost+found"
  "/home/*/.cache/*"
  "/var/cache/*"
  "*.tmp"
)

# ایجاد دایرکتوری Backup در صورت عدم وجود
mkdir -p "$BACKUP_DIR"

# ساخت دستور rsync
RSYNC_CMD="rsync -aAXv --delete"

# اضافه کردن excludeها
for item in "${EXCLUDE_LIST[@]}"; do
  RSYNC_CMD+=" --exclude=\"$item\""
done

# اضافه کردن مبدا و مقصد
RSYNC_CMD+=" / $BACKUP_DIR"

# اجرای دستور
echo "Running: $RSYNC_CMD"
eval $RSYNC_CMD

# بررسی نتیجه
if [ $? -eq 0 ]; then
  echo "Backup completed successfully on $(date)" >> "$BACKUP_DIR/backup.log"
else
  echo "Backup failed on $(date)" >> "$BACKUP_DIR/backup.log"
fi
```

## بازیابی Backup

برای بازیابی Backup ایجاد شده با rsync، می‌توانید از دستور معکوس استفاده کنید:

```bash
rsync -aAXv /backup/system/ /
```

**هشدار**: بازیابی باید در محیط Rescue یا با سیستم در حالت Single-User انجام شود.


# **محدودیت‌ها برای فرمت‌های مختلف فایل‌سیستم**

هنگام استفاده از `rsync` برای بک‌آپ، باید محدودیت‌های فایل‌سیستم‌های مختلف را در نظر بگیرید تا از مشکلات احتمالی جلوگیری کنید. در این بخش، مهم‌ترین محدودیت‌ها و راهکارهای آنها را بررسی می‌کنیم.

---

## **۱. محدودیت‌های NTFS (ویندوز / دیسک‌های اکسترنال)**
NTFS یک فایل‌سیستم مخصوص ویندوز است که در لینوکس از طریق `ntfs-3g` پشتیبانی می‌شود، اما محدودیت‌هایی دارد:

### **مشکلات رایج:**
| مشکل | توضیح | راهکار |
|------|-------|--------|
| **عدم پشتیبانی کامل از مجوزهای لینوکس (Permissions)** | NTFS به‌طور پیش‌فرض از مالکیت (`chown`) و مجوزهای یونیکسی (`chmod`) پشتیبانی نمی‌کند. | استفاده از `--no-perms --no-owner` در rsync |
| **مشکل با Extended Attributes (xattrs)** | NTFS ویژگی‌های توسعه‌یافته (`xattrs`) را به‌درستی ذخیره نمی‌کند. | حذف گزینه `-X` از rsync |
| **محدودیت در نام فایل‌ها** | NTFS برخی کاراکترهای خاص (`* ? < > : \ |`) را در نام فایل‌ها نمی‌پذیرد. | بررسی نام فایل‌ها قبل از انتقال |
| **مشکل با Symbolic Links** | لینک‌های نمادین (`symlinks`) ممکن است به‌درستی کار نکنند. | استفاده از `--copy-links` برای کپی کردن محتوا به جای لینک‌ها |

### **دستور rsync ایمن برای NTFS:**
```bash
rsync -rtvz --progress --no-perms --no-owner --modify-window=1 \
"/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```
- `-r` (recursive) به جای `-a` (به دلیل مشکلات permissions)
- `--modify-window=1` (برای جلوگیری از مشکلات timestamp در NTFS)

---

## **۲. محدودیت‌های FAT32/exFAT (دیسک‌های USB قدیمی)**
FAT32 و exFAT معمولاً در فلش‌درایوها و دیسک‌های اکسترنال استفاده می‌شوند، اما محدودیت‌های جدی دارند:

### **مشکلات رایج:**
| مشکل | توضیح | راهکار |
|------|-------|--------|
| **حداکثر حجم فایل: ۴GB (FAT32)** | FAT32 نمی‌تواند فایل‌های بزرگتر از ۴GB را ذخیره کند. | استفاده از exFAT یا NTFS |
| **عدم پشتیبانی از مجوزها** | هیچگونه اطلاعات مالکیت یا permissions ذخیره نمی‌شود. | استفاده از `--no-perms --no-owner` |
| **مشکل با نام فایل‌های بلند** | نام فایل‌ها نباید بیش از ۲۵۵ کاراکتر باشد. | کوتاه کردن نام فایل‌های بلند |
| **حساسیت به حروف بزرگ/کوچک** | FAT32 معمولاً به حروف حساس نیست (`file.txt` و `FILE.TXT` یکسان هستند). | اطمینان از عدم تداخل نام فایل‌ها |

### **دستور rsync ایمن برای FAT32/exFAT:**
```bash
rsync -rtv --progress --no-perms --no-owner --modify-window=1 \
--max-size=4G "/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```
- `--max-size=4G` (برای FAT32، جلوگیری از کپی فایل‌های بزرگتر از ۴GB)

---

## **۳. محدودیت‌های ext4/btrfs (لینوکس)**
فایل‌سیستم‌های لینوکس مانند `ext4` و `btrfs` از تمام ویژگی‌های rsync پشتیبانی می‌کنند، اما باید به چند نکته توجه کرد:

### **مشکلات رایج:**
| مشکل | توضیح | راهکار |
|------|-------|--------|
| **مصرف فضای زیاد برای metadata** | ویژگی‌هایی مانند ACLها و xattrs فضای اضافی مصرف می‌کنند. | در صورت کمبود فضا، از `-AX` صرف‌نظر کنید. |
| **مشکل با فایل‌های باز (مثلاً پایگاه داده)** | فایل‌های قفل‌شده ممکن است کپی نشوند. | استفاده از `lvm snapshot` یا توقف سرویس قبل از بک‌آپ |
| **محدودیت‌های سهمیه (quota)** | اگر سهمیه‌بندی (quota) فعال باشد، ممکن است با خطای فضای ذخیره‌سازی مواجه شوید. | بررسی `quota` با `repquota` |

### **دستور rsync بهینه برای ext4/btrfs:**
```bash
rsync -aAXvz --progress --numeric-ids \
"/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```
- `--numeric-ids` (برای حفظ UID/GID به جای نام کاربری)

---

## **۴. محدودیت‌های شبکه (NFS/Samba/SSH)**
اگر مقصد بک‌آپ یک سرور راه‌دور است، باید به محدودیت‌های شبکه توجه کنید:

### **مشکلات رایج:**
| مشکل | توضیح | راهکار |
|------|-------|--------|
| **اتصال ناپایدار** | قطع شدن شبکه باعث نیمه‌تمام ماندن بک‌آپ می‌شود. | استفاده از `--partial --timeout=300` |
| **مشکل با فایل‌های دارای hardlink** | برخی پروتکل‌های شبکه (مثل Samba) از hardlink پشتیبانی نمی‌کنند. | استفاده از `-H` فقط در صورت پشتیبانی |
| **محدودیت پهنای باند** | انتقال فایل‌های حجیم ممکن است شبکه را اشباع کند. | استفاده از `--bwlimit=5000` (مثلاً ۵۰۰۰KB/s) |

### **دستور rsync ایمن برای شبکه:**
```bash
rsync -aAXvz --progress --partial --timeout=300 -e ssh \
"/home/sajad/All Project/" "user@remote:/backup/All_Project_Backup/"
```

---

## **۵. فایل‌سیستم‌های خاص (ZFS, LVM, Encrypted)**
| فایل‌سیستم | مشکل | راهکار |
|------------|------|--------|
| **ZFS** | snapshotهای خودکار ممکن است با rsync تداخل داشته باشند. | استفاده از `zfs send/receive` به جای rsync |
| **LVM** | فایل‌سیستم‌های LVM نیاز به snapshotگیری دارند. | ایجاد LVM snapshot قبل از بک‌آپ |
| **Encrypted (LUKS)** | اگر پارتیشن رمزنگاری شده باشد، باید قبل از rsync باز شود. | استفاده از `cryptsetup open` |

---

## **جمع‌بندی: بهترین روش برای هر فایل‌سیستم**
| فایل‌سیستم | گزینه‌های rsync پیشنهادی |
|------------|-------------------------|
| **NTFS** | `-rtv --no-perms --no-owner --modify-window=1` |
| **FAT32/exFAT** | `-rtv --no-perms --no-owner --max-size=4G` |
| **ext4/btrfs** | `-aAXvz --numeric-ids` |
| **شبکه (SSH/NFS)** | `-aAXvz --partial --timeout=300 -e ssh` |
| **ZFS/LVM** | استفاده از ابزارهای مخصوص (`zfs send`, `lvcreate --snapshot`) |

# اطمینان از صحت بک آپ

برای اطمینان از صحت و سلامت بک‌آپ گرفته‌شده با `rsync`، می‌توانید از روش‌های زیر استفاده کنید:

---

## **۱. بررسی یکپارچگی داده‌ها (Integrity Check)**
### **الف) مقایسه حجم و تعداد فایل‌ها**
```bash
# محاسبه حجم پوشه مبدا و مقصد
du -sh "/home/sajad/All Project/"
du -sh "/mnt/backup/All_Project_Backup/"

# شمارش تعداد فایل‌ها
find "/home/sajad/All Project/" -type f | wc -l
find "/mnt/backup/All_Project_Backup/" -type f | wc -l
```
- ✅ حجم و تعداد فایل‌ها باید **یکسان** باشد.

### **ب) مقایسه محتوای فایل‌ها با `diff`**
```bash
diff -rq "/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```
- ✅ اگر خروجی نداشت، یعنی فایل‌ها **کاملاً یکسان** هستند.

### **ج) بررسی هش فایل‌ها (Checksum)**
```bash
# محاسبه MD5 هش برای فایل‌های مبدا و مقصد
find "/home/sajad/All Project/" -type f -exec md5sum {} + > /tmp/source.md5
find "/mnt/backup/All_Project_Backup/" -type f -exec md5sum {} + > /tmp/backup.md5

# مقایسه هش‌ها
diff /tmp/source.md5 /tmp/backup.md5
```
- ✅ عدم وجود تفاوت به معنای سلامت بک‌آپ است.

---

## **۲. بررسی ساختار فایل‌ها**
### **الف) اطمینان از حفظ مجوزها (Permissions)**
```bash
ls -l "/home/sajad/All Project/sample_file"
ls -l "/mnt/backup/All_Project_Backup/sample_file"
```
- ✅ مجوزها (مثلاً `-rw-r--r--`) باید یکسان باشند.

### **ب) بررسی Extended Attributes (اگر استفاده شده)**
```bash
getfattr -d "/home/sajad/All Project/sample_file"
getfattr -d "/mnt/backup/All_Project_Backup/sample_file"
```
- ✅ برای فایل‌سیستم‌های غیر-NTFS، باید مقادیر یکسان باشند.

---

## **۳. تست بازیابی (Recovery Test)**
### **الف) بازیابی یک فایل نمونه**
```bash
# کپی یک فایل از بک‌آپ به محل موقت
cp "/mnt/backup/All_Project_Backup/sample_file" /tmp/

# بررسی عملکرد فایل
file /tmp/sample_file
```
- ✅ فایل باید بدون خطا باز شود (مثلاً تصویر، PDF یا کد اجرایی).

### **ب) بازیابی کامل به یک مسیر تست**
```bash
mkdir -p /tmp/test_restore
rsync -a "/mnt/backup/All_Project_Backup/" "/tmp/test_restore/"
```
- ✅ سیستم باید بتواند تمام فایل‌ها را بازیابی کند.

---

## **۴. بررسی خطاهای پنهان**
### **الف) اسکن لاگ rsync**
```bash
grep -i "error\|fail\|warning" ~/.cache/rsync.log
```
- ✅ عدم وجود خطاهای بحرانی.

### **ب) بررسی فضای اشغال‌شده**
```bash
df -h /mnt/backup/
```
- ✅ فضای استفاده‌شده باید با حجم مبدا منطبق باشد.

---

## **۵. ابزارهای کمکی**
### **الف) استفاده از `rsync --checksum`**
برای اطمینان از تطابق محتوای فایل‌ها (بدون توجه به timestamp):
```bash
rsync -avc --dry-run "/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```
- ✅ اگر خروجی نداشت، فایل‌ها یکسان هستند.

### **ب) ابزار `rclone check` (برای بک‌آپ‌های ابری)**
```bash
rclone check "/home/sajad/All Project/" "/mnt/backup/All_Project_Backup/"
```

---

## **جمع‌بندی: چک‌لیست سلامت بک‌آپ**
| اقدام | دستور/روش | معیار موفقیت |
|-------|-----------|--------------|
| **مقایسه حجم** | `du -sh` | حجم مبدا و مقصد یکسان باشد |
| **مقایسه تعداد فایل‌ها** | `find | wc -l` | تعداد فایل‌ها برابر باشد |
| **مقایسه محتوا** | `diff -rq` | بدون تفاوت باشد |
| **بررسی مجوزها** | `ls -l` | مجوزها یکسان باشند |
| **تست بازیابی** | `cp + file` | فایل‌ها قابل استفاده باشند |
| **بررسی خطاها** | `grep error` | هیچ خطایی وجود نداشته باشد |

اگر تمام مراحل بالا را با موفقیت گذراندید، بک‌آپ شما **سالم و قابل اعتماد** است! 🔒